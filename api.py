import numpy as np
import os
import json
import pickle
from collections import defaultdict
from importance import permutation_importance

files = ['ffridataset2020_malware.jsonl', 'ffridataset2020_cleanware.jsonl']
api_count = defaultdict(int)
inno = 0
borl = 0
for fname in files:
    with open(fname) as fp:
        for line in fp:
            data = json.loads(line)
            lief = data['lief']
            imp = lief.get('imports')
            if imp is not None:
                for dll in imp:
                    dll_name = dll['name'].lower()
                    for api in dll['entries']:
                        if 'name' in api.keys():
                            api_count[dll_name + ':' + api['name']] += 1
                        else:
                            api_count[dll_name + ':' + 'ord{}'.format(api['ordinal'])] += 1
            for k in data['trid'].keys():
                if '(.EXE)InnoSetupinstaller' in k:
                    inno += 1
                if '(.EXE)DOSBorlandcompiledExecutable(generic)' in k:
                    borl += 1


api_count = dict(api_count)
cnt_list = sorted(api_count.items(), key=lambda x:x[1], reverse=True)
with open('api_count.txt', 'wb') as fp:
    pickle.dump(cnt_list, fp)

print(inno)
print(borl)
print(cnt_list)

idx = 0
for dll, count in cnt_list:
    if count < 1000:
        print(idx)
        break
    idx += 1
