import numpy as np
import os
import json
import pickle
import re

files = ['ffridataset2020_malware.jsonl', 'ffridataset2020_cleanware.jsonl']

if os.path.isfile('./trid.txt'):
    with open('trid.txt', 'rb') as fp:
        def_list = pickle.load(fp)
else:
    defs = set()

    for fname in files:
        with open(fname) as fp:
            for line in fp:
                data = json.loads(line)
                for k in data['trid'].keys():
                    m = re.match(r'(.+)\([0-9/]+\)$', k)
                    defs.add(m.group(1))

    def_list = list(defs)
    def_list.sort()
    with open('trid.txt', 'wb') as fp:
        pickle.dump(def_list, fp)

if os.path.isfile('./trid.npy'):
    trid_array = np.load('trid.npy')
else:
    dim = len(def_list)
    index = dict(zip(def_list, range(dim)))
    trid_array = np.zeros((150000, dim))
    i = 0
    for fname in files:
        with open(fname) as fp:
            for line in fp:
                data = json.loads(line)
                for k, v in data['trid'].items():
                    m = re.match(r'(.+)\([0-9/]+\)$', k)
                    p = re.match(r'([0-9\.]+)%$', v)
                    trid_array[i][index[m.group(1)]] = float(p.group(1))
                i += 1
    np.save('trid', trid_array)

print(trid_array)
for i in range(10):
    print(trid_array[0][10*i:10*i+10])
